# 安全算法

[TOC]



## 网络通信过程中的问题

通过网络传输数据时可能会发生 4 个主要问题

1. **窃听**：A 向 B 发送的消息可能会在传输途中被 X 偷看；
2. **假冒**：A 以为向 B 发送了消息，然而 B 有可能是 X 冒充的；
3. **篡改**：即便 B 确实收到了 A 发送的消息，但也有可能像右图 这样，该消息的内容在途中就被 X 更改了。除被第三者篡改外，通信故障导致的数据损坏也可能会使消息内容发生变化；
4. **事后否认**：B 从 A 那里收到了消息，但作为消息发送者的 A 可 能对 B 抱有恶意，并在事后声称这不是我发送的消息。

这些问题不光发生在用户之间交流的时候，也有可能发生在用户浏览网页的时候。

## 主要解决路径

针对这几个情况，一般使用不同的解决办法，常用解决方案有：

1. **加密**：给需要保密的数据加密，加密后第三者无法理解的数据称为密文，发送给目标之后需要对方进行解密得到原文；
2. **消息认证码**：
3. **数字签名**：

数字签名存在无法确认公开密钥的制作者的问题。要想解决这个问题，可以使用**数字证书**。

| 问题     | 解决方案               |
| -------- | ---------------------- |
| 窃听     | 加密                   |
| 假冒     | 消息认证码 或 数字签名 |
| 篡改     | 消息认证码 或 数字签名 |
| 事后否认 | 数字签名               |

### 哈希函数

哈希函数可以把给定的数据转换成固定长度的无规律数值。转换后的无规律数值可以作为 数据摘要应用于各种各样的场景。

可以把哈希函数理解成搅拌机，将原文数据输入哈希函数，输出固定长度的无规律数值。

哈希函数有以下几个特点

1. 无论输入什么数据，即使输入比较大的数据，或者输入很小的数据，输出的**长度都是固定**的；
2. 输出的数值称为哈希值，一般用**十六进制**表示；
3. 哈希函数是幂等的，也就是说输入同样的数据，输出的哈希值也是相同的；
4. 即使输入的两个数据完全不同，输出的哈希值也有可能相同，这称为**哈希冲突**；
5. 哈希函数是不可逆的，从输出的哈希值无法反推出原文。

哈希函数被广泛使用，比如在哈希表和消息认证码上。

比如我们经常听到的 MD5、SHA-1、SHA-2 算法等，前两个存在安全隐患已不推介，现在 SHA-2 是使用比较广泛的哈希算法。

一个很常用的场景是，将用户输入的密码保存到服务器时就会用到哈希函数。

如果把密码直接保存到服务器，可能会被第三者窃听，因此需要算出密码的哈希值，并只存储哈希值。当用户输入密码时，先算出该输入密码的哈希值，再把它和服务 器中的哈希值进行比对。这样一来，就算保存的哈希值暴露了，鉴于上文提到的哈希函数不可逆特性，窃听者也无法得知原本的密码。

就像这样，使用哈希函数可以更安全地实现基于密码的用户认证。

### 数据加密方式

加密数据的方法可以分为下面几种：

1. **对称加密**：加密和解密都使用相同密钥，又称共享密钥加密。通常加解密速度很快，适合经常发送数据的场合，缺点是密钥的安全传递；
2. **非对称加密**：分别使用不同密钥加密解密，也就是我们常说的公钥私钥加密，又称公开密钥加密。通常加解密速度比较慢，适合偶尔发送数据的场合；
3. **混合加密**：使用非对称加密来传输对称加密的密钥，这样既能避免非对称加解密速度比较慢的问题，也解决了对称加密的密钥安全传输问题。

#### 对称加密

对称加密方式就是加密和解密都是使用相同密钥，发送者将原文使用密钥加密后传输给接收者，接受者使用协商好的密钥来将密文解密得到原文，在此过程中，即使被第三者窃听，也只能拿到加密后的密文。

注意，密钥不能在网络上传播，否则就会泄漏密钥，因为第三者拿到了密钥也同样可以正确解密。所以需要做好协商，比如面对面沟通，或者打电话，或者使用非对称加密的方式来传输（这就是 HTTPS 的原理）。

常用的解决方案有凯撒密码、动态口令、DES（Data Encryption Standard）、AES（Advanced Encryption Standard），其中 AES 是最常用的加密方式，微信小程序加密传输就是使用的这个加密算法。

1. 凯撒密码：使用替换加密来将明文中的所有字母都在字母表上向后（或向前）按照一个固定数目进行偏移替换成密文。比如当偏移量是 3，字母 A 替换成 D，B 变成 E，以此类推；
2. 动态口令：一次性密码，只能使用一次，根据专门算法、每隔一定时间比如 30 秒生成一个不可预测的随机数字组合，经常被使用在银行、游戏之类的场景；
3. DES：由于现在的计算机计算能力已经很强大，已经不是一种安全的加密方法，主要因为它使用的 56 位密钥过短；
4. AES：现在最流行的对称加密算法，经过十几轮眼花缭乱的矩阵计算输出密文。

因为对称加密的使用的密钥不能在线传递，所以如何安全传递密钥就是关键，这就是**密钥分配问题**。

密钥分配问题一般有两个解决方式：

1. **密钥交换协议**：以 DH 算法为例，可以在不安全的环境下安全传输密钥。双方各自生成自己的私钥和公钥，私钥仅对自己可见，然后交换公钥，并根据自己的私钥和对方的公钥，生成最终的密钥，通过数学保证了双方各自计算出的最终密钥是相同的。但这种方式并未解决中间人攻击，并不能确保与自己通信的是否真的是对方；
2. **非对称加密**：即下文要讲的公钥私钥加密。

#### 非对称加密

加密和解密用的密钥是不同的，这种加密方式是用数学上的难解问题构造的，通常加密解密的速度比较慢，适合偶尔发送数据的场合。优点是密钥传输方便。

用来加密的密钥称为**公钥**，解密用的叫**私钥**。常见的非对称加密算法为 RSA、ECC 等。

由接收者来生成公钥和私钥，然后将私钥传递给发送者，发送者用公钥来加密数据并将密文传递给接收者，接收者使用私钥来解密得到原文。

在此过程中，公钥和密文是通过网络传播的，可能会被窃听，但仅获得公钥是只能加密数据而无法解密，因此窃听者无法正确解密。

但是第三者可以伪装成接收者生成假冒的公钥和私钥，在正牌的接收者发送公钥给接收者时，第三者可以使用假冒的公钥替换掉正牌公钥，这样接收者使用冒牌的公钥加密数据，发送数据的时候被第三者接收到使用冒牌私钥解密，就可以得到原文了，这就是**中间人攻击**。

所以，发送者需要确定自己收到的公钥确实是由接收者提供的，而不是第三者，这就是公钥的**可靠性问题**。

#### 混合加密

为了解决非对称加密速度较慢的问题，混合加密就是兼顾的解决方案。

用处理速度较快的共享密钥加密对数据进行加密。不过，加密时使用的密钥，则需要用没有密钥分配问题的公开密钥加密进行处理。

能够为网络提供通信安全的 TSL（Transport Layer Security） 协议就是使用的混合加密方式。对，就是 HTTPS 相对于 HTTP 协议增加的 SSL/TLS 协议。

#### ❌消息验证码

#### 数字签名

数字签名不仅可以实现消息认证码的认证和检测篡改功能，还可以预防事后否认问题的发生。由于在消息认证码中使用的是对称加密，所以持有密钥的接收者也有可能是消息的发送者，这样是无法预防事后否认行为的。而数字签名是只有发送者才能生成的，因此使用它就可以确定谁是消息的发送者了。

1. 和非对称加密刚好相反，首先发送者生成公钥和私钥，然后向接收者发送公钥；
2. 发送者使用私钥加密信息，加密后的消息就是数字签名，然后发送者将数字签名发送给接收者；
3. 接受者使用公钥解密，并确认是不是和收到的消息一致。

公开密钥加密的加密和解密都比较耗时。为了节约运算时间，一般不会对消息直接进行加密，而是先求得消息的哈希值，再对哈希值进行加密，然后将其作为签名来使用。

虽然通过数字签名接收者觉得对方就是发送者，但也有可能对方是第三者。
