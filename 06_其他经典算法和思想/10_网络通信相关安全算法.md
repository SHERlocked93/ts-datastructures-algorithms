# 一次安全可靠的网络通信-从根儿上理解HTTPS

[TOC]

最近互联网安全事故频发， HTTPS 越来越普及，

后文使用的几个角色：

1. A 指代消息请求者，一般为客户端；
2. B 指代消息接收者和返回者，一般为服务端；
3. X 指代第三方，通常不怀好意，意图窃听、篡改通信信息。



## 网络通信过程中的问题

通过网络传输数据时可能会发生 4 个主要问题：

1. **窃听**：A 向 B 发送的消息可能会在传输途中被 X 偷看；
2. **假冒**：A 以为向 B 发送了消息，然而 B 有可能是 X 冒充的；
3. **篡改**：即便 B 确实收到了 A 发送的消息，但消息的内容可能在途中被 X 更改了，或者通信故障导致的数据损坏也可能会使消息内容发生变化；
4. **事后否认**：B 从 A 那里收到了消息，但作为消息发送者的 A 可能对 B 抱有恶意，并在事后声称这不是我发送的消息。

这些问题不光发生在用户之间交流的时候，也有可能发生在用户浏览网页的时候。

## 主要解决路径 

针对这几个情况，一般使用不同的解决办法，常用解决方案有：

1. **加密**：给需要保密的数据加密，加密后第三者无法理解的数据称为密文，发送给目标之后需要对方进行解密得到原文；
2. **数字签名**：
3. **数字证书**：引入第三方权威机构对加密的公钥进行认证，确保通信双方身份的有效性，从而避免 X 假冒 B 的情况。

数字签名存在无法确认公开密钥的制作者的问题。要想解决这个问题，可以使用**数字证书**。

| 问题     | 解决方案 |
| -------- | -------- |
| 窃听     | 加密     |
| 假冒     | 数字证书 |
| 篡改     | 数字签名 |
| 事后否认 | 数字签名 |

后文将围绕这几个解决方案介绍使用的技术思路，最后这些技术共同构建起了当前 HTTPS 通信的安全城墙。

## 哈希函数

哈希函数可以把给定的数据转换成固定长度的无规律数值。转换后的无规律数值可以作为 数据摘要应用于各种各样的场景。

可以把哈希函数理解成搅拌机，将原文数据输入哈希函数，输出固定长度的无规律数值。

哈希函数有以下几个特点

1. 无论输入什么数据，即使输入比较大的数据，或者输入很小的数据，输出的**长度都是固定**的；
2. 输出的数值称为哈希值，一般用**十六进制**表示；
3. 哈希函数是幂等的，也就是说输入同样的数据，输出的哈希值也是相同的；
4. 即使输入的两个数据完全不同，输出的哈希值也有可能相同，这称为**哈希冲突**；
5. 哈希函数是不可逆的，从输出的哈希值无法反推出原文。

哈希函数被广泛使用，比如在哈希表和消息认证码上。

比如我们经常听到的 MD5、SHA-1、SHA-2 算法等，前两个存在安全隐患已不推介，现在 SHA-2 是使用比较广泛的哈希算法。



一个很常用的场景是，将用户输入的密码保存到服务器时就会用到哈希函数。

如果把密码直接保存到服务器，可能会被第三者窃听，因此需要算出密码的哈希值，并只存储哈希值。当用户输入密码时，先算出该输入密码的哈希值，再把它和服务 器中的哈希值进行比对。这样一来，就算保存的哈希值暴露了，鉴于上文提到的哈希函数不可逆特性，窃听者也无法得知原本的密码。

就像这样，使用哈希函数可以更安全地实现基于密码的用户认证。

目前大部分提供下载服务的网站都有提供文件的 SHA256（SHA-2 的一个标准之一） 值，这是因为哈希函数的不可逆性具备防篡改的效果，若是下载的文件的 SHA256 和网站提供的值不符，则可能此文件已经遭到了修改。

## 数据加密方式

加密数据的方法可以分为下面几种：

1. **对称加密**：加密和解密都使用相同密钥，又称共享密钥加密。通常加解密速度很快，适合经常发送数据的场合，缺点是密钥的安全传递；
2. **非对称加密**：分别使用不同密钥加密解密，也就是我们常说的公钥私钥加密，又称公开密钥加密。通常加解密速度比较慢，适合偶尔发送数据的场合；
3. **混合加密**：使用非对称加密来传输对称加密的密钥，这样既能避免非对称加解密速度比较慢的问题，也解决了对称加密的密钥安全传输问题。

### 对称加密

对称加密方式就是加密和解密都是使用相同密钥，发送者将原文使用密钥加密后传输给接收者，接受者使用协商好的密钥来将密文解密得到原文，在此过程中，即使被第三者窃听，也只能拿到加密后的密文。

注意，密钥不能在网络上传播，否则就会泄漏密钥，因为第三者拿到了密钥也同样可以正确解密。所以需要做好协商，比如面对面沟通，或者打电话，或者使用非对称加密的方式来传输（这就是 HTTPS 的原理）。

常用的解决方案有凯撒密码、动态口令、DES（Data Encryption Standard）、AES（Advanced Encryption Standard），其中 AES 是最常用的加密方式，微信小程序加密传输就是使用的这个加密算法。

1. 凯撒密码：使用替换加密来将明文中的所有字母都在字母表上向后（或向前）按照一个固定数目进行偏移替换成密文。比如当偏移量是 3，字母 A 替换成 D，B 变成 E，以此类推；
2. 动态口令：一次性密码，只能使用一次，根据专门算法、每隔一定时间比如 30 秒生成一个不可预测的随机数字组合，经常被使用在银行、游戏之类的场景；
3. DES：由于现在的计算机计算能力已经很强大，已经不是一种安全的加密方法，主要因为它使用的 56 位密钥过短；
4. AES：现在最流行的对称加密算法，经过十几轮眼花缭乱的矩阵计算输出密文。

因为对称加密的使用的密钥不能在线传递，所以如何安全传递密钥就是关键，这就是**密钥分配问题**。

密钥分配问题一般有两个解决方式：

1. **密钥交换协议**：以 DH 算法为例，可以在不安全的环境下安全传输密钥。双方各自生成自己的私钥和公钥，私钥仅对自己可见，然后交换公钥，并根据自己的私钥和对方的公钥，生成最终的密钥，通过数学保证了双方各自计算出的最终密钥是相同的。但这种方式并未解决中间人攻击，并不能确保与自己通信的是否真的是对方；
2. **非对称加密**：即下文要讲的公钥私钥加密。

### 非对称加密

加密和解密用的密钥是不同的，这种加密方式是用数学上的难解问题构造的，通常加密解密的速度比较慢，适合偶尔发送数据的场合。优点是密钥传输方便。

用来加密的密钥称为**公钥**，解密用的叫**私钥**。常见的非对称加密算法为 RSA、ECC 等。

由接收者来生成公钥和私钥，然后将私钥传递给发送者，发送者用公钥来加密数据并将密文传递给接收者，接收者使用私钥来解密得到原文。

在此过程中，公钥和密文是通过网络传播的，可能会被窃听，但仅获得公钥是只能加密数据而无法解密，因此窃听者无法正确解密。

但是第三者可以伪装成接收者生成假冒的公钥和私钥，在正牌的接收者发送公钥给接收者时，第三者可以使用假冒的公钥替换掉正牌公钥，这样接收者使用冒牌的公钥加密数据，发送数据的时候被第三者接收到使用冒牌私钥解密，就可以得到原文了，这就是**中间人攻击**。

所以，发送者需要确定自己收到的公钥确实是由接收者提供的，而不是第三者，这就是公钥的**可靠性问题**。

### 混合加密

为了解决非对称加密速度较慢的问题，混合加密就是兼顾的解决方案。

用处理速度较快的共享密钥加密对数据进行加密。不过，加密时使用的密钥，则需要用没有密钥分配问题的公开密钥加密进行处理。

能够为网络提供通信安全的 TSL（Transport Layer Security） 协议就是使用的混合加密方式。

对，就是 HTTPS 相对于 HTTP 协议增加的 SSL/TLS 协议。

## 数字签名

数字签名是只有消息的发送者才能产生，别人无法伪造的一段数字串，这段数字串同时也是发送者的信息真实性的有效证明。 

1. 和非对称加密刚好相反，首先发送者生成公钥和私钥，然后向接收者发送公钥；
2. 发送者使用私钥加密信息，加密后的消息就是数字签名，然后发送者将数字签名发送给接收者；
3. 接受者使用公钥解密，并确认是不是和收到的消息一致。

非对称加密的加密和解密都比较耗时。为了节约运算时间，一般不会对消息直接进行加密，而是先对消息执行哈希函数获得消息的哈希值，一般称之为摘要 Digest，再对哈希值使用私钥加密，这就是数字签名 Signature。

数字签名可以保障消息的完整性，即使文件有很小的改动，哈希函数生成的摘要也是不相同的。

由于第三者假冒不了发送方的私钥签名，发送者是用自己的私钥对信息进行加密的，只有使用发送方的公钥才能解密，所以解决了事后否认问题。

但是数字签名无法解决中间人攻击问题，因为接收者虽然收到了发送者的信息，并确保了信息没有被篡改，但是这个信息也有可能是第三方生成的，由于第三方也可以使用相同的哈希算法对文件生成签名，所以接收者可以验证文件没有被篡改，但无法确认文件的发送方。

## 数字证书

非对称加密和数字签名都无法解决中间人攻击的问题，数字证书就是解决这个问题的。接上面提到的公钥可靠性问题，下面是数字证书的逻辑：

1. 接收者（一般是服务端）生成自己的公钥私钥之后，首先要向权威认证中心 CA（Certification Authority） 申请证书，证明公钥确实是自己生成的；
2. 认证机构也有着自己的公钥私钥，机构使用自己的私钥根据接收者的个人信息（比如服务端网址、邮箱）生成**数字签名**，并将这个数字签名和接受者的个人信息一起作为**数字证书**还给接收者。这些都是发送者和接收者通信之前接收者所做的。
3. 发送者要跟接收者进行通信了，首先发送者发起了对接收者的通信请求，接收者将之前的数字证书发送给发送者；
4. 发送者对数字证书进行验证，数字证书是否为认证中心给出的，且其中的信息确实是接收者的信息（比如地址）之后，发送者就可以获取证书中接收者的公钥，由此接收者的公钥就安全转移给了发送者；
5. 后面发送者使用接收者公钥来将生成的对称加密密钥进行加密，接收者获取之后使用自己的私钥解密获得发送者生成的对称加密密钥，之后进行对称加密通信。

所以这个数字证书包括哪些内容呢：

1. 接受者的个人信息，比如服务端的地址等内容；
2. 证书信息，比如这个证书是什么 机构发布的，方便发送者找到对应机构进行验证；
3. 接受者的公钥，如果证书验证没有问题，发送者将证书中的接收者公钥取出加密自己生成的对称加密密钥。

这就是 HTTPS 的通信过程，其中 1-4 步就是 `HTTPS` 中的 SSL/TSL 协议所封装的安全逻辑。





---
网上的帖子大多深浅不一，甚至有些前后矛盾，在下的文章都是学习过程中的总结，如果发现错误，欢迎留言指出，如果本文帮助到了你，别忘了点赞支持一下哦，你的点赞是我更新的最大动力！（收藏不点赞，都是耍流氓 🤣）~


> 参考文档：
>
> 1. [什么是 HTTPS 协议？](https://mp.weixin.qq.com/s/1ojSrhc9LZV8zlX6YblMtA)
> 2. [数字签名是什么？ - 阮一峰](http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html)
> 3. [一次安全可靠的通信——HTTPS原理 | 微信开放社区](https://developers.weixin.qq.com/community/develop/article/doc/000046a5fdc7802a15f7508b556413)

PS：本文收录在在下的博客 [Github - SHERlocked93/blog](https://github.com/SHERlocked93/blog) 系列文章中，欢迎大家关注我的公众号 `前端下午茶`，直接搜索即可添加或者点[这里](https://cdn.jsdelivr.net/gh/SHERlocked93/pic@master/uPic/TJt4p2-19-56-21.jpg)添加，持续为大家推送前端以及前端周边相关优质技术文，共同进步，一起加油~

另外可以加入「前端下午茶交流群」微信群，微信搜索  `qianyu443033099` 加我好友，备注**加群**，我拉你入群～
